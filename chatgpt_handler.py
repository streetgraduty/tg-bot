import gigachat
from cfg import GIGACHAT_API_KEY

async def get_gpt_response(user_message: str) -> str:
    try:
        # Инициализация клиента GigaChat
        with gigachat.GigaChat(credentials=GIGACHAT_API_KEY, verify_ssl_certs=False) as giga:
            # Создаем сообщение в формате, который ожидает GigaChat
            payload = {
                "model": "GigaChat:latest",
                "messages": [{
                    "role": "system",
                    "content": """Ты - опытный преподаватель физики, который помогает студентам и школьникам. 
                    Твои ответы должны быть:
                    1. Научно точными
                    2. Понятными для учащихся
                    3. Содержать формулы в простом текстовом формате (например, P*V = const)
                    4. Включать примеры из реальной жизни
                    5. При решении задач - показывать пошаговое решение
                    
                    Не используй LaTeX или специальные символы. Используй обычные текстовые обозначения для формул.
                    Например:
                    - Вместо $$ P \propto T $$ пиши P ~ T
                    - Вместо $ P_1 $ пиши P1
                    - Вместо дроби $$\frac{P_2}{T_2}$$ пиши P2/T2
                    - Для степеней используй ^2, ^3 и т.д.
                    - Для произведения используй *
                    - Для научной нотации используй e (например, 6.674e-11)
                    
                    Если вопрос не связан с физикой, вежливо напомни, что ты специализируешься на физике и физических задачах."""
                }, {
                    "role": "user",
                    "content": user_message
                }]
            }
            
            # Отправляем запрос
            response = giga.chat(payload)
            
            return response.choices[0].message.content

    except Exception as e:
        return f"""Произошла ошибка при обработке запроса: {str(e)}
        
Пожалуйста, попробуйте переформулировать вопрос или обратитесь позже."""
